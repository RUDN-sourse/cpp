# Лабораторная работа: "Работа с базами данных в C++"

## Цель работы
Освоить практические навыки работы с базами данных в C++ using SQLite, изучить основные операции CRUD, транзакции, безопасность и оптимизацию запросов.

## Теоретическая часть

### Необходимые знания:
- Основы C++ (классы, исключения, умные указатели)
- SQL синтаксис (SELECT, INSERT, UPDATE, DELETE)
- Основы работы с указателями
- Паттерны проектирования (Repository, Unit of Work)

### Используемые библиотеки:
- SQLite3 (`sqlite3.h`)
- Стандартная библиотека C++

## Практическая часть

### Задание 1: Базовая настройка и создание таблиц

**Цель:** Создать класс для работы с базой данных и реализовать инициализацию таблиц.

**Задача:** 
1. Создайте класс `DatabaseManager` с методами для подключения к базе данных
2. Реализуйте создание таблиц `students` и `grades`
3. Добавьте базовую оптимизацию базы данных

**Требования к таблицам:**
```sql
students (id INTEGER PRIMARY KEY, name TEXT NOT NULL, email TEXT UNIQUE, group_name TEXT)
grades (id INTEGER PRIMARY KEY, student_id INTEGER, subject TEXT, grade INTEGER, 
        FOREIGN KEY(student_id) REFERENCES students(id) ON DELETE CASCADE)
```

**Критерии оценки:**
- ✓ Корректное создание таблиц
- ✓ Обработка ошибок подключения
- ✓ Оптимизация настроек базы данных

---

### Задание 2: CRUD операции и подготовленные выражения

**Цель:** Реализовать основные операции создания, чтения, обновления и удаления записей.

**Задача:**
Создайте класс `StudentRepository` со следующими методами:
- `addStudent(name, email, group)`
- `getStudent(id)`
- `updateStudent(id, newName, newEmail, newGroup)`
- `deleteStudent(id)`
- `getAllStudents()`

**Требования:**
- Использовать подготовленные выражения
- Проверять уникальность email
- Обрабатывать ошибки внешних ключей

**Пример использования:**
```cpp
StudentRepository repo(db);
repo.addStudent("Иван Иванов", "ivan@university.ru", "CS-101");
auto student = repo.getStudent(1);
```

**Критерии оценки:**
- ✓ Корректная работа всех CRUD операций
- ✓ Использование подготовленных выражений
- ✓ Обработка ошибок целостности данных

---

### Задание 3: Работа с транзакциями и сложными запросами

**Цель:** Освоить работу с транзакциями и выполнение сложных SQL-запросов.

**Задача:**
1. Реализуйте метод `addStudentWithGrades()` который добавляет студента и его оценки в одной транзакции
2. Создайте методы для статистики:
   - `getStudentsByGroup(group_name)`
   - `getAverageGradeBySubject(subject)`
   - `getTopStudents(limit)`

**Требования:**
- Использовать транзакции для атомарных операций
- Реализовать JOIN запросы для получения связанных данных
- Добавить обработку ошибок транзакций

**Пример:**
```cpp
// Добавление студента с оценками в одной транзакции
std::vector<Grade> grades = {{"Math", 85}, {"Physics", 90}};
repo.addStudentWithGrades("Петр Петров", "petr@university.ru", "CS-101", grades);

// Получение статистики
auto topStudents = repo.getTopStudents(5);
```

**Критерии оценки:**
- ✓ Корректная работа транзакций
- ✓ Правильные JOIN запросы
- ✓ Обработка ошибок в транзакциях

---

### Задание 4: Безопасность и валидация данных

**Цель:** Реализовать защиту от SQL-инъекций и валидацию входных данных.

**Задача:**
1. Создайте класс `InputValidator` для проверки:
   - Корректности email
   - Длины строковых полей
   - Диапазона оценок (0-100)
   - Отсутствия SQL-инъекций в входных данных

2. Модифицируйте `StudentRepository` для использования валидатора

**Требования:**
- Блокировать потенциально опасные символы в строках
- Проверять формат email
- Ограничивать длину вводимых данных
- Возвращать понятные сообщения об ошибках

**Пример:**
```cpp
InputValidator validator;
if (!validator.isValidEmail(email)) {
    throw std::invalid_argument("Invalid email format");
}
if (!validator.isSafeInput(name)) {
    throw std::invalid_argument("Potential SQL injection detected");
}
```

**Критерии оценки:**
- ✓ Полная валидация всех входных данных
- ✓ Защита от SQL-инъекций
- ✓ Понятные сообщения об ошибках

---

### Задание 5: Оптимизация и тестирование

**Цель:** Оптимизировать производительность и протестировать работу системы.

**Задача:**
1. Реализуйте пакетную вставку данных (`batchInsertStudents`)
2. Создайте индексы для часто используемых запросов
3. Напишите unit-тесты для всех методов репозитория
4. Протестируйте производительность с большим объемом данных (1000+ записей)

**Требования:**
- Использовать транзакции для пакетной вставки
- Создать индексы для полей `email`, `group_name`, `subject`
- Написать тесты с использованием Google Test или аналогичного фреймворка
- Измерить время выполнения операций

**Пример теста:**
```cpp
TEST(StudentRepositoryTest, AddStudentValidData) {
    DatabaseManager db;
    db.initialize(":memory:");
    StudentRepository repo(db.getHandle());
    
    EXPECT_TRUE(repo.addStudent("Test User", "test@test.com", "TEST-001"));
    auto student = repo.getStudent(1);
    EXPECT_EQ(student.name, "Test User");
}
```

**Критерии оценки:**
- ✓ Работающая пакетная вставка
- ✓ Созданные индексы
- ✓ Измерена производительность
